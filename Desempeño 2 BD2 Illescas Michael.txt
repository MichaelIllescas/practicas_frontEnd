ALUMNO: Michael Jonathan Illescas
MATERIA: Bases de Datos 2.
CARRERA: Desarrollo de Software

Dado el diagrama desarrollado en la clase 1 de la asignatura, se pide:

a/ Suponiendo que el estado PENDIENTE es id=1 , escribe el CREATE de un Store Procedure que no reciba ni devuelva parametros, que busque todas las solicitudes pendientes con fechaDeCarga mayor a dos meses (es decir que se cargo hace dos meses o más) y automáticamente setee el estado de las mismas a VENCIDA (id=7).

b/ Crea un Trigger sobre la tabla SOLICITUDES en donde al actualizar el estado de alguna solicitud, registre sobre la tabla LogCambios el ID de la solicitud que cambio, en que fecha y hora se cambio y el ID del nuevo estado al que se cambio. 



a/ Stored Procedure:


CREATE PROCEDURE ActualizarSolicitudesVencidas
AS
BEGIN
    UPDATE SOLICITUDES
    SET EstadoID = 7
    WHERE EstadoID = 1 AND fechaDeCarga <= DATEADD(MONTH, -2, GETDATE());
END;




b/ Trigger para el Log de Cambios:


CREATE TRIGGER LogCambiosSolicitudes
ON SOLICITUDES
AFTER UPDATE
AS
BEGIN
    IF UPDATE(EstadoID)
    BEGIN
        INSERT INTO LogCambios (SolicitudID, FechaHoraCambio, NuevoEstadoID)
        SELECT
            SolicitudID,
            GETDATE(),
            EstadoID AS NuevoEstadoID
        FROM DELETED;
    END
END;
